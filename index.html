<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner E-904 / E-120</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 20px; text-align: center; }
        #interactive.viewport { width: 100%; height: 300px; border: 2px solid #333; overflow: hidden; position: relative; }
        #interactive.viewport video { width: 100%; height: 100%; object-fit: cover; }
        canvas.drawingBuffer { position: absolute; left: 0; top: 0; }
        .btn { padding: 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; width: 100%; }
        #result { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .danger { background: #ffcccc; color: #cc0000; border: 2px solid #cc0000; }
        .safe { background: #ccffcc; color: #006600; border: 2px solid #006600; }
    </style>
</head>
<body>

    <h2>Detector de Aditivos</h2>
    
    <div id="interactive" class="viewport"></div>
    
    <button class="btn" onclick="startScanner()">Encender Cámara</button>
    
    <div style="margin: 20px 0;">
        <input type="text" id="barcodeInput" placeholder="O escribe el código a mano" style="padding: 10px; width: 60%;">
        <button onclick="checkProduct(document.getElementById('barcodeInput').value)">Buscar</button>
    </div>

    <div id="result"></div>

    <script>
        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: { facingMode: "environment" }
                },
                decoder: { readers: ["ean_reader", "ean_8_reader"] }
            }, function(err) {
                if (err) { console.error(err); return; }
                Quagga.start();
            });

            Quagga.onDetected((data) => {
                const code = data.codeResult.code;
                document.getElementById('barcodeInput').value = code;
                Quagga.stop();
                checkProduct(code);
            });
        }

        async function checkProduct(barcode) {
            const resDiv = document.getElementById('result');
            resDiv.style.display = 'block';
            resDiv.innerHTML = "Consultando...";
            resDiv.className = "";

            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                const data = await response.json();

                if (data.status === 0) {
                    resDiv.innerHTML = "Producto no encontrado.";
                    return;
                }

                const product = data.product;
                const additives = product.additives_tags || [];
                // Buscamos E120 (Cochinilla) o E904 (Goma Laca)
                const found = additives.filter(a => a.includes('e120') || a.includes('e904'));

                if (found.length > 0) {
                    resDiv.className = "danger";
                    resDiv.innerHTML = `<strong>¡CUIDADO!</strong><br>${product.product_name}<br>Contiene: ${found.join(', ').toUpperCase()}`;
                } else {
                    resDiv.className = "safe";
                    resDiv.innerHTML = `<strong>TODO OK</strong><br>${product.product_name}<br>No lleva E-120 ni E-904.`;
                }
            } catch (e) {
                resDiv.innerHTML = "Error de conexión.";
            }
        }
    </script>
</body>
      </html>
