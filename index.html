<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>escaner de bichos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Contenedor C√°mara */
        #scanner-container { width: 100%; height: 250px; border: 2px solid #333; display: none; margin-bottom: 20px; position: relative; overflow: hidden; border-radius: 8px; }
        #scanner-container video { width: 100%; height: 100%; object-fit: cover; }
        
        .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }

        .product-item { padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 8px solid; background: #fff; display: flex; align-items: center; gap: 15px; }
        .danger { border-color: #dc3545; background: #fff5f5; }
        .safe { border-color: #28a745; background: #f8fff8; }
        img { width: 60px; height: 60px; object-fit: contain; }
    </style>
</head>
<body>

<div class="card">
    <h2>Detector de Aditivos</h2>
    
    <div id="scanner-container"></div>

    <div class="controls">
        <button class="btn btn-green" onclick="toggleCamera()">üì∑ Abrir C√°mara para Escanear</button>
        <input type="text" id="searchInput" placeholder="Escribe nombre o c√≥digo de barras...">
        <button class="btn btn-blue" onclick="searchProduct()">Buscar por Texto</button>
    </div>

    <div id="results"></div>
</div>

<script>
    let scannerActive = false;

    function toggleCamera() {
        const container = document.getElementById('scanner-container');
        if (!scannerActive) {
            container.style.display = 'block';
            startScanner();
        } else {
            stopScanner();
        }
    }

    function startScanner() {
        scannerActive = true;
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-container'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader"] }
        }, (err) => {
            if (err) { alert("Error c√°mara: " + err); return; }
            Quagga.start();
        });

        Quagga.onDetected((data) => {
            const code = data.codeResult.code;
            document.getElementById('searchInput').value = code;
            stopScanner();
            fetchData(`https://world.openfoodfacts.org/api/v2/product/${code}.json`, true);
        });
    }

    function stopScanner() {
        Quagga.stop();
        document.getElementById('scanner-container').style.display = 'none';
        scannerActive = false;
    }

    async function searchProduct() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;
        
        // Si es num√©rico largo, buscamos por c√≥digo, si no, por nombre
        const url = isNaN(query) 
            ? `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1`
            : `https://world.openfoodfacts.org/api/v2/product/${query}.json`;
        
        fetchData(url, !isNaN(query));
    }

    async function fetchData(url, isSingle) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "Buscando...";

        try {
            const resp = await fetch(url);
            const data = await resp.json();
            const products = isSingle ? [data.product] : data.products;

            if (!products || products.length === 0 || data.status === 0) {
                resultsDiv.innerHTML = "No encontrado.";
                return;
            }

            resultsDiv.innerHTML = "";
            products.forEach(p => {
                if(!p) return;
                const additives = p.additives_tags || [];
                const found = additives.filter(a => a.includes('e120') || a.includes('e904'));
                const isDanger = found.length > 0;

                const div = document.createElement('div');
                div.className = `product-item ${isDanger ? 'danger' : 'safe'}`;
                div.innerHTML = `
                    <img src="${p.image_small_url || ''}" onerror="this.style.display='none'">
                    <div>
                        <strong>${p.product_name || 'Desconocido'}</strong><br>
                        <small>${isDanger ? '‚ö†Ô∏è CONTIENE: ' + found.join(', ').toUpperCase().replace(/EN:/g,'') : '‚úÖ LIBRE de E-120/E-904'}</small>
                    </div>
                `;
                resultsDiv.appendChild(div);
            });
        } catch (e) {
            resultsDiv.innerHTML = "Error de conexi√≥n.";
        }
    }
</script>

</body>
</html>
